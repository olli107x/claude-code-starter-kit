#!/bin/bash
# Pre-Commit Hook - Bug Pattern Checks
# Installation: cp pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

echo "Running Pre-Commit Bug Pattern Checks..."

ERRORS=0

# ================================================
# 1. API PARAMS: Check for undefined serialization
# ================================================
echo "  Checking API params..."
if grep -rn "params:" --include="*.ts" --include="*.tsx" src/ 2>/dev/null | grep -v "Record<string" | grep -v "// safe" > /dev/null; then
    echo "  WARNING: Possible undefined in API params (use Record<string, string>)"
    grep -rn "params:" --include="*.ts" --include="*.tsx" src/ 2>/dev/null | grep -v "Record<string" | grep -v "// safe" | head -5
fi

# ================================================
# 2. REACT QUERY: Check for missing placeholderData
# ================================================
echo "  Checking React Query..."
if grep -rn "useQuery" --include="*.tsx" src/ 2>/dev/null | grep -v "placeholderData" | grep -v "enabled: false" | grep -v "// no-placeholder" > /dev/null; then
    echo "  WARNING: useQuery without placeholderData (data may disappear on refetch)"
    grep -rn "useQuery" --include="*.tsx" src/ 2>/dev/null | grep -v "placeholderData" | grep -v "enabled: false" | head -3
fi

# ================================================
# 3. BUTTONS: Check for missing disabled state
# ================================================
echo "  Checking buttons..."
if grep -rn "<Button" --include="*.tsx" src/ 2>/dev/null | grep "onClick" | grep -v "disabled" | grep -v "// no-disable" > /dev/null; then
    echo "  WARNING: Button without disabled state (double-submit risk)"
    grep -rn "<Button" --include="*.tsx" src/ 2>/dev/null | grep "onClick" | grep -v "disabled" | head -3
fi

# ================================================
# 4. SECURITY: Hardcoded secrets
# ================================================
echo "  Checking for hardcoded secrets..."
if grep -rn "api_key\s*=\s*['\"]" --include="*.ts" --include="*.tsx" --include="*.py" . 2>/dev/null | grep -v ".env" | grep -v "process.env" | grep -v "os.getenv" | grep -v "example" > /dev/null; then
    echo "  CRITICAL: HARDCODED API KEY DETECTED!"
    ERRORS=1
fi

if grep -rn "password\s*=\s*['\"][^'\"]\+['\"]" --include="*.ts" --include="*.tsx" --include="*.py" . 2>/dev/null | grep -v ".env" | grep -v "example" | grep -v "placeholder" > /dev/null; then
    echo "  CRITICAL: HARDCODED PASSWORD DETECTED!"
    ERRORS=1
fi

# ================================================
# 5. CONSOLE.LOG: Remove before commit
# ================================================
echo "  Checking for console.log..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')
if [ -n "$STAGED_FILES" ]; then
    for file in $STAGED_FILES; do
        if grep -n "console\.log" "$file" 2>/dev/null | grep -v "// keep" > /dev/null; then
            echo "  WARNING: console.log found in $file"
        fi
    done
fi

# ================================================
# 6. PYTHON: Type hints
# ================================================
echo "  Checking Python type hints..."
if grep -rn "^def " --include="*.py" app/ 2>/dev/null | grep -v "->" | grep -v "__" | grep -v "# no-type" > /dev/null; then
    echo "  WARNING: Python function without return type hint"
    grep -rn "^def " --include="*.py" app/ 2>/dev/null | grep -v "->" | grep -v "__" | head -3
fi

# ================================================
# RESULT
# ================================================
if [ $ERRORS -eq 1 ]; then
    echo ""
    echo "Pre-commit failed! Fix security issues before committing."
    exit 1
fi

echo "Pre-commit checks passed"
exit 0
